{% extends 'base.html' %}

{% block title %}V√©rification GPS - Pointage Arrosage{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white text-center">
                <h4>üìç V√©rification de Position</h4>
            </div>
            <div class="card-body text-center">
                <div id="status">
                    <div class="spinner-border text-success mb-3" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="lead">V√©rification de votre position GPS...</p>
                    <p class="text-muted">Veuillez autoriser l'acc√®s √† votre localisation</p>
                </div>
                
                <div id="resultat" class="d-none">
                    <!-- R√©sultat affich√© par JavaScript -->
                </div>
                
                <button id="btn-retester" class="btn btn-primary d-none" onclick="verifierPosition()">
                    üîÑ R√©essayer
                </button>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">‚ÑπÔ∏è Informations</h6>
                <ul class="small">
                    <li>Vous devez √™tre physiquement au champ</li>
                    <li>Rayon autoris√© : <strong>50 m√®tres</strong></li>
                    <li>La g√©olocalisation doit √™tre activ√©e</li>
                    <li>Connexion internet requise</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// V√©rifier automatiquement la position au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    verifierPosition();
});

function verifierPosition() {
    const statusDiv = document.getElementById('status');
    const resultatDiv = document.getElementById('resultat');
    const btnRetester = document.getElementById('btn-retester');
    
    // R√©initialiser l'affichage
    statusDiv.classList.remove('d-none');
    resultatDiv.classList.add('d-none');
    btnRetester.classList.add('d-none');
    
    if (!navigator.geolocation) {
        afficherErreur('‚ùå G√©olocalisation non support√©e par votre navigateur');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        // Succ√®s
        function(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const precision = position.coords.accuracy;
            
            console.log('Position obtenue:', latitude, longitude, 'Pr√©cision:', precision + 'm');
            
            // Envoyer au serveur pour v√©rification
            fetch('{% url "verifier_gps" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude
                })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.classList.add('d-none');
                resultatDiv.classList.remove('d-none');
                
                if (data.success) {
                    resultatDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>‚úÖ Position Valid√©e !</h5>
                            <p>${data.message}</p>
                            <p class="small mb-0">Redirection en cours...</p>
                        </div>
                    `;
                    
                    // Rediriger vers le formulaire apr√®s 2 secondes
                    setTimeout(function() {
                        window.location.href = data.redirect_url;
                    }, 2000);
                } else {
                    resultatDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚ùå Position Refus√©e</h5>
                            <p>${data.message}</p>
                            <p class="small mb-0">Vous devez √™tre au champ pour continuer.</p>
                        </div>
                    `;
                    btnRetester.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                afficherErreur('‚ùå Erreur de connexion au serveur');
            });
        },
        // Erreur
        function(error) {
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "‚ùå Vous avez refus√© l'acc√®s √† la g√©olocalisation. Veuillez l'autoriser dans les param√®tres de votre navigateur.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "‚ùå Impossible d'obtenir votre position. V√©rifiez que le GPS est activ√©.";
                    break;
                case error.TIMEOUT:
                    message = "‚ùå La demande de g√©olocalisation a expir√©. R√©essayez.";
                    break;
                default:
                    message = "‚ùå Erreur inconnue lors de la g√©olocalisation.";
            }
            afficherErreur(message);
        },
        // Options
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function afficherErreur(message) {
    const statusDiv = document.getElementById('status');
    const resultatDiv = document.getElementById('resultat');
    const btnRetester = document.getElementById('btn-retester');
    
    statusDiv.classList.add('d-none');
    resultatDiv.classList.remove('d-none');
    
    resultatDiv.innerHTML = `
        <div class="alert alert-danger">
            <h5>Erreur</h5>
            <p>${message}</p>
        </div>
    `;
    
    btnRetester.classList.remove('d-none');
}
</script>
{% endblock %}